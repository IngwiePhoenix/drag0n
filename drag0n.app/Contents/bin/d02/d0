#!/bin/bash
# Dragon v0.1
# Creator: IngwiePhoenix

# Config:
if [ -f "/Drag0n/config.d0" ]; then
	. /Drag0n/config.d0
	echo "Config loaded from installation."
elif [ -f "$(pwd)/config.d0" ]; then
	. "$(pwd)/config.d0"
	echo "Config loaded from scratch."
	echo "You may want to install Drag0n."
else
	echo "...oops. Failed to load the config."; exit 3
fi

# coloring output:
d0_log() { printf "%b" "$(tput setaf 2)$*$(tput sgr0)\n"; }
d0_debug() { printf "%b" "$(tput setaf 5)Debug> $*$(tput sgr0)\n"; }
d0_warn() { printf "%b" "$(tput setaf 3)Warning> $*$(tput sgr0)\n"; }
d0_error() { printf "%b" "$(tput setaf 1)ERROR> $*$(tput sgr0)\n" 1>&2 ; }

#### Functions ####
# Installer 
d0install() {
	if [ -d $root ]; then
		d0_log "> The main folder exists."
		read -p "Want to re-build structure? {y/n} > " o
		case $o in
			y|Y) d0install2 ;;
			*|n|N) d0_log "> Aborting." ;;
		esac
	else
		d0install2
	fi
}		
d0install2() {
	d0_log "> Creating root."
	mkdir -pv "$root"
	mkdir -pv "$upgraded"
	
	d0_log "> Creating information places."
	for folder in "$infd" "$screend" "$pkgd" "$srcd"
		do
			mkdir -pv "$folder"
		done
	
	d0_log "> Creating user specials."
	for folder in "$usr" "$usr_sourced" "$usr_s_upload" "$usr_s_confd"
		do
			mkdir -pv "$folder"
		done
}

upgrade() {
	curl $update_srv >$TEMP
	if [ $? != "0" ]; then
		d0_error "There was an error downloading the file. Please try again later."
		exit
	fi
	. $TEMP
	echo "Current version: $version"
	echo "New version: $nversion"
	echo "------------------------------"
	echo $update_desc
	echo "------------------------------"
cat <<EOF
You have the following options:
	
	install   :: Install the update.
	changelog :: Read the changelog
	website   :: Open the website for more informtions. 
	exit      :: Exit this screen.
EOF
	read -p "Drag0n Updater> " input
	case $input in
		install)
			curl -# $pkg_url >"${root}/${upgraded}/${nversion}.d0p-update"
			if [ $? != "0" ]; then
				d0_error "There was a problem with the download. Aborting."
				exit
			else
				d0_log "Fetched file off $update_srv"
				d0_log "Prepaing installation..."
				d0p_installer "${root}/${upgrade}/${nversion}.d0p-update"
			fi;	exit ;;
		changelog) echo $changelog; upgrade ;;
		website) open "$desc_url" ;;
		exit) exit ;;
		* ) d0_error "No vaild input, try again."; upgrade ;;
	esac
}
d0p_installer() {
	pname=$(basename $1)
	mv -v "$1" "$instd/$pname"
	mkdir -v "$instd/$pname.d"
	tar xvfz "$instd/$pname" "$instd/$pname.d"
	list="$(du -a $instd/$pname.d | awk '{print $2}' | sed 's/.//g; s/..//g; s/$instd\/$pname.d//g; d/.d0//')"
	for file in $list
		do
			echo "file> $file"
		done
	echo $list > "$instd/$pname.d/.d0/files.d0"
	read -p "Do you want to install this package? The above files will be moved to their respective folder. {y|n} " answer
	case $answer in
		y|Y)
			d0_log "Installing from \'$pname\'"
			mv -v "$instd/$pname.d/.d0" "$instd/$pname.inst.d"
			chmod +x "$instd/$pname.inst.d/"*
			d0_log "Hooking up the package informations."
			. "$instd/$pname.inst.d/info.d0"
			d0_log "Package name is: $pkg_name"
			
			if [ -f "$instd/$pname.inst.d/preinst" ]; then
				d0_log "Processing preinst..."
				eval "$instd/$pname.inst.d/preinst"
			fi
			
			d0_log "Moving files..."
			for file in $list
				do
					echo "-> Installing: $file"
					if [ -f "/$file" ] || [ -d "/$file" ]; then
						mv -v "/$file" "/$file.old_d0"
					fi
					cp -v "$instd/$pname.d/$file" "/$file"
				done
				
			if [ -f "$instd/$pname.inst.d/postinst" ]; then
				d0_log "Processing postinst..."
				eval "$instd/$pname.inst.d/postinst"
			fi
			
			d0_log "Removing archive file..."
			rm -v "$1"
			d0_log "Successfully installed $pkg_name" ;;
		*|n|N) 
			d0_log "Aborting the installation now."
			rm -Rdv "$instd/$pname.d"
			rm -v "$instd/$pname" 
			d0_log "Removed all files."
			exit ;;
	esac
}
d0info() {
cat <<EOF
This is Drag0n, a wanna-be package manager, that allows you to install 3rd-party software via the terminal in a apt-like fashion.
I don't take any responsibillity if your computer was broken due to an installed package - so take care, what you're going to install!

Drag0n
	Version: 0.1
	Creator: IngwiePhoenix (ingwie2000@gmail.com)
	Created for: MacOS X and any Linux-based system.
	Website: drag0n.tk
	
Commands:
	d0-related:
		help    :: This help
		inst    :: Install Drag0n onto your file-system. Note: Edit the provided config-file to suit your needs.
		upgrade :: Upgrade the script.
		
	Installer:
		load    :: Update the sources.
		add     :: add a source. You can provide the url like: d0 update "http://yourdomain.tld/d0"
		remove  :: Remove a source.
		
	Userland:
		create  :: Create a custom d0-Source.
		kill    :: Kill a created source.
		upload  :: Upload the source, depending on it's configurations.

Credits:
	Cytec: http://cytec.us
	Several thousands of tutorials that I googled off the internet.
EOF
}

d0cmd() {
cat <<EOF
Can't handle parameter(s): $*
Please type "$(basename $0) help" for more help.
EOF
}

# Source update/add
sourceupdate() {
	d0_log "> Updating sources."
	
	#Grabbing screen+pkg
	for src in "$( ls -1 $srcd/*.d0s )"
		do
			. "$src"
			d0_log "-> Fetching screen from URL $url"
			curl -# $url/screen.d0 >$TEMP
			. $TEMP
			cp -v $TEMP $screend/$sname.d0
			#d0_log "-> Fetching pkg"
			#curl $url/pkg.d0 >$pkgd/$sname.d0
		done
	
	# creating source-table
	d0_log "> Updating table..."
	echo  $'----- \n Name (URL) \n\t Description \n ----- \n' >$table
	for s in "$( ls -1 $screend/* )"
		do
			. "$s"
			echo -e "$name ($url)" >>$table
			echo -e "\t $desc" >>$table
		done
	d0_log "> Table updated successfully!"
	
	d0_log "> Update was successfull."
}

sourceadd() {
	if [ "$1" != "" ]; then
		sourceadd2 "$1"
	else
		echo "Please enter the full URL of the source that you wanna add"
		read -p "{http:// | https:// | ftp://}> " url
		sourceadd2 "$url"
	fi
}
sourceadd2() {
	curl -# $1/screen.d0 >$TEMP
	cURLerr=$?
	case $cURLerr in
		1|3) d0_warn "You have an error in your URL. Please check it again."; ret=0 ;;
		6|7) d0_warn "Host not reachable."; ret=0 ;;
		8) d0_warn "Weird FTP error."; ret=0 ;;
		9) d0_warn "FTP: Access denied."; ret=0 ;;
		0) d0_log "File is acceptable!"; ret=1 ;;
	esac
	case $ret in
		0) d0_error "There was a problem with the download of the file, we're aborting the adding for now."; exit ;;
		1) d0_log "OK!" ;;
	esac
	if cat $TEMP | grep -q "<html>"; then
		d0_error "Oops, error. It's a HTML file! This is maybe not the wanted output, is it?"
		echo "-------------"
		cat $TEMP
		echo "-------------"
	else
		. $TEMP
		cp -v $TEMP $screend/$sname.d0
#		d0_log "Now, fetching package list."
#		curl -# $1/pkg.d0 >$pkgd/$sname.d0
		d0_log "Adding the source."
		echo "url=\"$1\"" > "${srcd}/${sname}.d0s"
	fi
}


# Wohoo...start o.o
d0_debug "$1 | $2"
case $1 in
	
	# Installation.
	inst     ) d0install        ;;
#	upgrade  ) d0update         ;; # Upgrade Drag0n to newest version.
	help     ) d0info           ;;
	
	#Installer
	load	 ) sourceupdate 	;;
	add      ) sourceadd "$2"   ;;
#	remove   ) sourceremove     ;; # Remove a repo.

	#Create
#	create   ) screate          ;; # Create a Drag0n source.
#	kill     ) skill            ;; # Erase a whole source. Requires the short-name as parameter
# 	upload   ) supload          ;; # Upload a source. Requires the short-name of the source as parameter.

	*        ) d0cmd "$*"		;; 


esac